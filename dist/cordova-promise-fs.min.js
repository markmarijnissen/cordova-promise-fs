/*! cordova-promise-fs 14-07-2015 */
!function(){"use strict";function a(b,c,d,e){b.getDirectory(c[0],{create:!0},function(b){c.length>1?a(b,c.slice(1),d,e):d(b)},e)}function b(a){return a=a.substr(0,a.lastIndexOf("/")+1),"/"===a[0]&&(a=a.substr(1)),a}function c(a){return a.substr(a.lastIndexOf("/")+1)}function d(a){a=a||"","/"===a[0]&&(a=a.substr(1));for(var b=a.split("/"),c=1;c<b.length;c++)".."===b[c]?(b.splice(c-1,2),c-=2):"."===b[c]&&(b.splice(c,1),c--);return a=b.join("/"),"./"===a&&(a=""),a}var e=[],f=0;module.exports=function(g){function h(a){return new D(function(b){return b(a)})}function i(b){return new D(function(c,d){return G.then(function(e){b?(b=b.split("/").filter(function(a){return a&&a.length>0&&"."!==a&&".."!==a}),a(e.root,b,c,d)):c(e.root)},d)})}function j(a,b){return new D(function(c,e){return"object"==typeof a?c(a):(a=d(a),b=b||{},G.then(function(d){d.root.getFile(a,b,c,e)},e))})}function k(a,b){return a=d(a),"/"===a.substr(-1)&&(a=a.substr(0,a.length-1)),b=b||{},new D(function(c,d){return G.then(function(e){a&&"/"!==a?e.root.getDirectory(a,b,c,d):c(e.root)},d)})}function l(a,b){b=b||"";var c=b.indexOf("r")>-1,d=b.indexOf("e")>-1,e=b.indexOf("f")>-1,f=b.indexOf("d")>-1;return e&&f&&(e=!1,f=!1),new D(function(b,g){return k(a).then(function(a){var i=a.createReader();i.readEntries(function(a){var i=[h(a)];c&&a.filter(function(a){return a.isDirectory}).forEach(function(a){i.push(l(a.fullPath,"re"))}),D.all(i).then(function(a){var c=[];c=c.concat.apply(c,a),e&&(c=c.filter(function(a){return a.isFile})),f&&(c=c.filter(function(a){return a.isDirectory})),d||(c=c.map(function(a){return a.fullPath})),b(c)},g)},g)},g)})}function m(a){return new D(function(b,c){j(a).then(function(a){b(a)},function(a){1===a.code?b(!1):c(a)})})}function n(a){return i(b(a)).then(function(){return j(a,{create:!0})})}function o(a){return j(a).then(function(a){return a.toURL()})}function p(a,b){return b=b||"readAsText",j(a).then(function(a){return new D(function(c,d){a.file(function(a){var d=new FileReader;d.onloadend=function(){c(this.result)},d[b](a)},d)})})}function q(a){return p(a,"readAsDataURL")}function r(a){return p(a).then(JSON.parse)}function s(a,c,d){return i(b(a)).then(function(){return j(a,{create:!0})}).then(function(a){return new D(function(b,e){a.createWriter(function(a){a.onwriteend=b,a.onerror=e,"string"==typeof c?c=t([c],d||"text/plain"):c instanceof Blob!=!0&&(c=t([JSON.stringify(c,null,4)],d||"application/json")),a.write(c)},e)})})}function t(a,b){var c,d;try{return new Blob(a,{type:b})}catch(e){if(c=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)return d=new c,d.append(a),d.getBlob(b);throw new Error("Unable to create blob")}}function u(a,d){return i(b(d)).then(function(b){return j(a).then(function(a){return new D(function(e,f){a.moveTo(b,c(d),e,f)})})})}function v(a,d){return i(b(d)).then(function(b){return j(a).then(function(a){return new D(function(e,f){a.copyTo(b,c(d),e,f)})})})}function w(a,b){var c=b?j:m;return new D(function(b,d){c(a).then(function(a){a!==!1?a.remove(b,d):b(1)},d)}).then(function(a){return 1===a?!1:!0})}function x(a){return k(a).then(function(a){return new D(function(b,c){a.removeRecursively(b,c)})})}function y(){for(;e.length>0&&f<g.concurrency;){f++;var a=e.pop(),b=a.shift(),c=a.shift(),d=a.shift(),h=a.shift(),i=a.shift(),j=a.shift(),k=a.shift(),l=a.shift();b._aborted?f--:c?(b.download.call(b,d,h,i,j,k,l),b.onprogress&&b.onprogress(new ProgressEvent)):b.upload.call(b,h,d,i,j,l,k)}}function z(a){return f--,y(),a}function A(a,b,d,h,i){"function"==typeof h&&(i=h,h={}),F&&d.indexOf("://")<0&&(d=I(d)),h=h||{},h.retry&&h.retry.length||(h.retry=g.retry),h.retry=h.retry.concat(),h.file||a||(h.fileName=c(d));var j=new FileTransfer;i=i||h.onprogress,"function"==typeof i&&(j.onprogress=i);var k=new D(function(c,g){var i=function(f){if(0===h.retry.length)g(f);else{e.unshift([j,a,b,d,c,i,h.trustAllHosts||!1,h]);var k=h.retry.shift();k>0?setTimeout(z,k):z()}};h.retry.unshift(0),f++,i()});return k.then(z,z),k.progress=function(a){return j.onprogress=a,k},k.abort=function(){return j._aborted=!0,j.abort(),k},k}function B(a,b,c,d){return A(!0,a,b,c,d)}function C(a,b,c,d){return A(!1,b,a,c,d)}var D=g.Promise||window.Promise;if(!D)throw new Error("No Promise library given in options.Promise");this.options=g=g||{},g.persistent=void 0!==g.persistent?g.persistent:!0,g.storageSize=g.storageSize||20971520,g.concurrency=g.concurrency||3,g.retry=g.retry||[];var E,F="undefined"!=typeof cordova;F?E=new D(function(a,b){document.addEventListener("deviceready",a,!1),setTimeout(function(){b(new Error("deviceready has not fired after 5 seconds."))},5100)}):(E=h(!0),"undefined"!=typeof webkitRequestFileSystem?(window.requestFileSystem=webkitRequestFileSystem,window.FileTransfer=function(){},FileTransfer.prototype.download=function(a,b,c,d){var e=new XMLHttpRequest;return e.open("GET",a),e.responseType="blob",e.onreadystatechange=function(){4===e.readyState&&(200===e.status?s(b,e.response).then(c,d):d(e.status))},e.send(),e},window.ProgressEvent=function(){},window.FileEntry=function(){}):window.requestFileSystem=function(a,b,c,d){d(new Error("requestFileSystem not supported!"))});var G=new D(function(a,b){E.then(function(){var c=g.persistent?1:0;g.fileSystem&&(c=g.fileSystem),!F&&c>1&&(console.warn('Chrome does not support fileSystem "'+c+'". Falling back on "0" (temporary).'),c=0),isNaN(c)?window.resolveLocalFileSystemURL(c,function(b){a(b.filesystem)},b):window.requestFileSystem(c,g.storageSize,a,b),setTimeout(function(){b(new Error("Could not retrieve FileSystem after 5 seconds."))},5100)},b)});G.then(function(a){window.__fs=a},function(a){console.error("Could not get Cordova FileSystem:",a)});var H,I;return F?(I=function(a){return a=d(a),a.indexOf("://")<0?"cdvfile://localhost/"+(g.persistent?"persistent/":"temporary/")+a:a},H=function(a){return j(a).then(function(a){return a.toInternalURL()})}):(I=function(a){return a=d(a),"filesystem:"+location.origin+(g.persistent?"/persistent/":"/temporary/")+a},H=function(a){return j(a).then(function(a){return a.toURL()})}),{fs:G,normalize:d,file:j,filename:c,dir:k,dirname:b,create:n,read:p,readJSON:r,write:s,move:u,copy:v,remove:w,removeDir:x,list:l,ensure:i,exists:m,download:B,upload:C,toURL:o,isCordova:F,toInternalURLSync:I,toInternalURL:H,toDataURL:q,deviceready:E,options:g,Promise:D}}}();