/*! cordova-promise-fs 13-07-2015 */
function __createDir(a,b,c,d){a.getDirectory(b[0],{create:!0},function(a){b.length>1?__createDir(a,b.slice(1),c,d):c(a)},d)}function dirname(a){return a=a.substr(0,a.lastIndexOf("/")+1),"/"===a[0]&&(a=a.substr(1)),a}function filename(a){return a.substr(a.lastIndexOf("/")+1)}function normalize(a){a=a||"","/"===a[0]&&(a=a.substr(1));for(var b=a.split("/"),c=1;c<b.length;c++)".."===b[c]?(b.splice(c-1,2),c-=2):"."===b[c]&&(b.splice(c,1),c--);return a=b.join("/"),"./"===a&&(a=""),a}var transferQueue=[],inprogress=0;module.exports=function(a){function b(a){return new x(function(b){return b(a)})}function c(a){return new x(function(b,c){return A.then(function(d){a?(a=a.split("/").filter(function(a){return a&&a.length>0&&"."!==a&&".."!==a}),__createDir(d.root,a,b,c)):b(d.root)},c)})}function d(a,b){return new x(function(c,d){return"object"==typeof a?c(a):(a=normalize(a),b=b||{},A.then(function(e){e.root.getFile(a,b,c,d)},d))})}function e(a,b){return a=normalize(a),"/"===a.substr(-1)&&(a=a.substr(0,a.length-1)),b=b||{},new x(function(c,d){return A.then(function(e){a&&"/"!==a?e.root.getDirectory(a,b,c,d):c(e.root)},d)})}function f(a,c){c=c||"";var d=c.indexOf("r")>-1,g=c.indexOf("e")>-1,h=c.indexOf("f")>-1,i=c.indexOf("d")>-1;return h&&i&&(h=!1,i=!1),new x(function(c,j){return e(a).then(function(a){var e=a.createReader();e.readEntries(function(a){var e=[b(a)];d&&a.filter(function(a){return a.isDirectory}).forEach(function(a){e.push(f(a.fullPath,"re"))}),x.all(e).then(function(a){var b=[];b=b.concat.apply(b,a),h&&(b=b.filter(function(a){return a.isFile})),i&&(b=b.filter(function(a){return a.isDirectory})),g||(b=b.map(function(a){return a.fullPath})),c(b)},j)},j)},j)})}function g(a){return new x(function(b,c){d(a).then(function(a){b(a)},function(a){1===a.code?b(!1):c(a)})})}function h(a){return c(dirname(a)).then(function(){return d(a,{create:!0})})}function i(a){return d(a).then(function(a){return a.toURL()})}function j(a,b){return b=b||"readAsText",d(a).then(function(a){return new x(function(c,d){a.file(function(a){var d=new FileReader;d.onloadend=function(){c(this.result)},d[b](a)},d)})})}function k(a){return j(a,"readAsDataURL")}function l(a){return j(a).then(JSON.parse)}function m(a,b,e){return c(dirname(a)).then(function(){return d(a,{create:!0})}).then(function(a){return new x(function(c,d){a.createWriter(function(a){a.onwriteend=c,a.onerror=d,"string"==typeof b?b=n([b],e||"text/plain"):b instanceof Blob!=!0&&(b=n([JSON.stringify(b,null,4)],e||"application/json")),a.write(b)},d)})})}function n(a,b){var c,d;try{return new Blob(a,{type:b})}catch(e){if(c=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)return d=new c,d.append(a),d.getBlob(b);throw new Error("Unable to create blob")}}function o(a,b){return c(dirname(b)).then(function(c){return d(a).then(function(a){return new x(function(d,e){a.moveTo(c,filename(b),d,e)})})})}function p(a,b){return c(dirname(b)).then(function(c){return d(a).then(function(a){return new x(function(d,e){a.copyTo(c,filename(b),d,e)})})})}function q(a,b){var c=b?d:g;return new x(function(b,d){c(a).then(function(a){a!==!1?a.remove(b,d):b(1)},d)}).then(function(a){return 1===a?!1:!0})}function r(a){return e(a).then(function(a){return new x(function(b,c){a.removeRecursively(b,c)})})}function s(){for(;transferQueue.length>0&&inprogress<a.concurrency;){inprogress++;var b=transferQueue.pop(),c=b.shift(),d=b.shift(),e=b.shift(),f=b.shift(),g=b.shift(),h=b.shift(),i=b.shift(),j=b.shift();c._aborted?inprogress--:d?(c.download.call(c,e,f,g,h,i,j),c.onprogress&&c.onprogress(new ProgressEvent)):c.upload.call(c,f,e,g,h,j,i)}}function t(a){return inprogress--,s(),a}function u(b,c,d,e,f){"function"==typeof e&&(f=e,e={}),z&&d.indexOf("://")<0&&(d=C(d)),e=e||{},e.retry&&e.retry.length||(e.retry=a.retry),e.retry=e.retry.concat(),e.file||b||(e.fileName=filename(d));var g=new FileTransfer;f=f||e.onprogress,"function"==typeof f&&(g.onprogress=f);var h=new x(function(a,f){var h=function(i){if(0===e.retry.length)f(i);else{transferQueue.unshift([g,b,c,d,a,h,e.trustAllHosts||!1,e]);var j=e.retry.shift();j>0?setTimeout(t,j):t()}};e.retry.unshift(0),inprogress++,h()});return h.then(t,t),h.progress=function(a){return g.onprogress=a,h},h.abort=function(){return g._aborted=!0,g.abort(),h},h}function v(a,b,c,d){return u(!0,a,b,c,d)}function w(a,b,c,d){return u(!1,b,a,c,d)}var x=a.Promise||window.Promise;if(!x)throw new Error("No Promise library given in options.Promise");this.options=a=a||{},a.persistent=void 0!==a.persistent?a.persistent:!0,a.storageSize=a.storageSize||20971520,a.concurrency=a.concurrency||3,a.retry=a.retry||[];var y,z="undefined"!=typeof cordova;z?y=new x(function(a,b){document.addEventListener("deviceready",a,!1),setTimeout(function(){b(new Error("deviceready has not fired after 5 seconds."))},5100)}):(y=b(!0),"undefined"!=typeof webkitRequestFileSystem?(window.requestFileSystem=webkitRequestFileSystem,window.FileTransfer=function(){},FileTransfer.prototype.download=function(a,b,c,d){var e=new XMLHttpRequest;return e.open("GET",a),e.responseType="blob",e.onreadystatechange=function(a,f,g){4==e.readyState&&(200===e.status?m(b,e.response).then(c,d):d(e.status))},e.send(),e},window.ProgressEvent=function(){},window.FileEntry=function(){}):window.requestFileSystem=function(a,b,c,d){d(new Error("requestFileSystem not supported!"))});var A=new x(function(b,c){y.then(function(){var d=a.persistent?1:0;a.fileSystem&&(d=a.fileSystem),!z&&d>1&&(console.warn('Chrome does not support fileSystem "'+d+'". Falling back on "0" (temporary).'),d=0),isNaN(d)?window.resolveLocalFileSystemURL(d,function(a){b(a.filesystem)},c):window.requestFileSystem(d,a.storageSize,b,c),setTimeout(function(){c(new Error("Could not retrieve FileSystem after 5 seconds."))},5100)},c)});A.then(function(a){window.__fs=a},function(a){console.error("Could not get Cordova FileSystem:",a)});var B,C;return z?(C=function(b){return b=normalize(b),b.indexOf("://")<0?"cdvfile://localhost/"+(a.persistent?"persistent/":"temporary/")+b:b},B=function(a){return d(a).then(function(a){return a.toInternalURL()})}):(C=function(b){return b=normalize(b),"filesystem:"+location.origin+(a.persistent?"/persistent/":"/temporary/")+b},B=function(a){return d(a).then(function(a){return a.toURL()})}),{fs:A,normalize:normalize,file:d,filename:filename,dir:e,dirname:dirname,create:h,read:j,readJSON:l,write:m,move:o,copy:p,remove:q,removeDir:r,list:f,ensure:c,exists:g,download:v,upload:w,toURL:i,isCordova:z,toInternalURLSync:C,toInternalURL:B,toDataURL:k,deviceready:y,options:a,Promise:x}};